C251 COMPILER V5.60.0,  bootloader                                                         20/10/24  17:59:15  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE bootloader
OBJECT MODULE PLACED IN .\Objects\bootloader.obj
COMPILER INVOKED BY: D:\Compiler\Keil_v5\C251\BIN\C251.EXE Bootloader\src\bootloader.c XSMALL FUNCTIONS(REENTRANT) FLOAT
                    -64 WARNINGLEVEL(3) OPTIMIZE(0,SIZE) BROWSE INCDIR(.\Bootloader\inc) DEBUG PRINT(.\bootloader.lst) TABS(2) OBJECT(.\Objec
                    -ts\bootloader.obj) 

stmt  level    source

    1          /*
    2           * bootloader.c
    3           *
    4           *  Created on: Mar. 25, 2020
    5           *      Author: Alka
    6           *  Porting on: Mar. 13, 2024
    7           *    Porting code from F051 to STC8051U
    8           *  
    9           *
   10           */
   11          
   12          #include "bootloader.h"
   13          #include <string.h>
   14          #include "stdio.h"
   15          
   16          
   17          #define page_size 0x200                   // 512 bytes for STC8051U
   18          
   19          extern void delayMicroseconds(uint32_t micros);
   20          
   21          void save_flash_nolib(uint8_t *dat, int length, uint32_t add){
   22   1      
   23   1        IAP_ENABLE();                         
   24   1        // unlock flash
   25   1        // erase page if address even divisable by 512
   26   1        if((add % page_size) == 0){
   27   2      
   28   2          IAP_ERASE();                        
   29   2      
   30   2          IAP_ADDRE = (uint8_t)(add >> 16); 
   31   2          IAP_ADDRH = (uint8_t)(add >> 8);  
   32   2          IAP_ADDRL = (uint8_t)add;         
   33   2      
   34   2          IAP_TRIG = 0x5A;
   35   2          IAP_TRIG = 0xA5;                   
   36   2          _nop_();   
   37   2          _nop_();
   38   2          _nop_();
   39   2          _nop_();
   40   2      
   41   2          while(CMD_FAIL)
   42   2          {
   43   3            printf("CMD_FAIL\n");
   44   3          }                  
   45   2        }
   46   1      
   47   1        IAP_WRITE();        //å®è°ƒç”¨, é€å­—èŠ‚å†™å‘½ä»¤
   48   1        do
   49   1          {
   50   2              IAP_ADDRE = (uint8_t)(add >> 16); 
   51   2              IAP_ADDRH = (uint8_t)(add >> 8);  
   52   2              IAP_ADDRL = (uint8_t)add;         
   53   2              IAP_DATA  = *dat;      
   54   2      
   55   2          IAP_TRIG = 0x5A;
   56   2          IAP_TRIG = 0xA5;                   
   57   2          _nop_();   
C251 COMPILER V5.60.0,  bootloader                                                         20/10/24  17:59:15  PAGE 2   

   58   2          _nop_();
   59   2          _nop_();
   60   2          _nop_();
   61   2      
   62   2          while(CMD_FAIL)
   63   2          {
   64   3            printf("CMD_FAIL\n");
   65   3          }
   66   2      
   67   2              add++;                     //ä¸‹ä¸€ä¸ªåœ°å€
   68   2              dat++;                    //ä¸‹ä¸€ä¸ªæ•°æ®
   69   2          }
   70   1          while(--length);                    //ç›´åˆ°ç»“æŸ
   71   1      
   72   1      
   73   1        IAP_DISABLE();                      //å…³é—­IAP
   74   1      }
   75          
   76          void read_flash_bin(uint8_t*  dat , uint32_t add , int out_buff_len){
   77   1        int i;
   78   1        IAP_ENABLE();                           //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤Ÿ
   79   1          IAP_READ();                             //é€å­—èŠ‚è¯»å‘½ä»¤ï¼Œå‘½ä»¤ä¸éœ€æ”¹å˜æ—¶ï¼Œä¸éœ€é‡æ–°é€
             -å‘½ä»¤
   80   1        for (i = 0; i < out_buff_len ; i ++){
   81   2          CMD_FAIL = 0;
   82   2              IAP_ADDRE = (uint8_t)((add+i) >> 16); //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   83   2              IAP_ADDRH = (uint8_t)((add+i) >> 8);  //é€åœ°å€ä¸­å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   84   2              IAP_ADDRL = (uint8_t)(add+i);         //é€åœ°å€ä½å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   85   2      
   86   2          IAP_TRIG = 0x5A;
   87   2          IAP_TRIG = 0xA5;                   
   88   2          _nop_();   
   89   2          _nop_();
   90   2          _nop_();
   91   2          _nop_();
   92   2          while(CMD_FAIL);
   93   2      
   94   2              dat[i] = IAP_DATA;            //è¯»å‡ºçš„æ•°æ®é€å¾€
   95   2        }
   96   1      
   97   1        IAP_DISABLE();                      
   98   1      }
   99          
  100          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       436     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        10     ------
C251 COMPILER V5.60.0,  bootloader                                                         20/10/24  17:59:15  PAGE 3   

End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

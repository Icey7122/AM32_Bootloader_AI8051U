C251 COMPILER V5.60.0,  eeprom                                                             24/10/24  23:51:05  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE eeprom
OBJECT MODULE PLACED IN .\Objects\eeprom.obj
COMPILER INVOKED BY: D:\Compiler\Keil_v5\C251\BIN\C251.EXE Mcu\8051U\Src\eeprom.c XSMALL FUNCTIONS(REENTRANT) FLOAT64 WA
                    -RNINGLEVEL(3) OPTIMIZE(3,SPEED) BROWSE INCDIR(.\Inc;.\Mcu\8051U\Inc) DEBUG PRINT(.\Listings\eeprom.lst) TABS(2) OBJECT(.
                    -\Objects\eeprom.obj) 

stmt  level    source

    1          /*
    2           * bootloader.c
    3           *
    4           *  Created on: Mar. 25, 2020
    5           *      Author: Alka
    6           *  Porting on: Mar. 13, 2024
    7           *    Porting code from F051 to STC8051U
    8           *  
    9           *
   10           */
   11          
   12          #include "eeprom.h"
   13          #include "stdlib.h"
   14          #include <string.h>
   15          
   16          #define page_size 0x200                   // 512 bytes for STC8051U
   17          
   18          bool save_flash_nolib(const uint8_t* dat, uint32_t length, uint32_t add)
   19          {
   20   1        uint32_t i;
   21   1        const uint8_t *p = dat;
   22   1        uint8_t* data_check;
   23   1      
   24   1      
   25   1        IAP_ENABLE();                         
   26   1        // unlock flash
   27   1        // erase page if address even divisable by 512
   28   1        if((add % page_size) == 0){
   29   2          CMD_FAIL = 0;
   30   2      
   31   2          IAP_ERASE();                        
   32   2      
   33   2          IAP_ADDRE = (uint8_t)(add >> 16); 
   34   2          IAP_ADDRH = (uint8_t)(add >> 8);  
   35   2          IAP_ADDRL = (uint8_t)add;         
   36   2      
   37   2          IAP_TRIG = 0x5A;
   38   2          IAP_TRIG = 0xA5;                   
   39   2          _nop_();   
   40   2          _nop_();
   41   2          _nop_();
   42   2          _nop_();
   43   2      
   44   2          while(CMD_FAIL);       
   45   2        }
   46   1      
   47   1        IAP_WRITE();        //å®è°ƒç”¨, é€å­—èŠ‚å†™å‘½ä»¤
   48   1      
   49   1        for (i = 0; i < length; i++)
   50   1        {
   51   2          CMD_FAIL = 0;
   52   2      
   53   2              IAP_ADDRE = (uint8_t)((add + i) >> 16); 
   54   2              IAP_ADDRH = (uint8_t)((add + i) >> 8);  
   55   2              IAP_ADDRL = (uint8_t)(add + i);         
   56   2              IAP_DATA  = *p;      
   57   2      
C251 COMPILER V5.60.0,  eeprom                                                             24/10/24  23:51:05  PAGE 2   

   58   2          IAP_TRIG = 0x5A;
   59   2          IAP_TRIG = 0xA5;                   
   60   2          _nop_();   
   61   2          _nop_();
   62   2          _nop_();
   63   2          _nop_();
   64   2      
   65   2          while(CMD_FAIL);
   66   2              p++;                    //ä¸‹ä¸€ä¸ªæ•°æ®
   67   2        }
   68   1        
   69   1        IAP_DISABLE();                      //å…³é—­IAP
   70   1      
   71   1        data_check = (uint8_t *)malloc(length);
*** WARNING C188 IN LINE 71 OF Mcu\8051U\Src\eeprom.c: 'parameter 1': value truncated
   72   1        read_flash_bin(data_check, add, length);
*** WARNING C188 IN LINE 72 OF Mcu\8051U\Src\eeprom.c: 'parameter 3': value truncated
   73   1      
   74   1        if (memcmp(dat, data_check, length) == 0){
*** WARNING C188 IN LINE 74 OF Mcu\8051U\Src\eeprom.c: 'parameter 3': value truncated
*** WARNING C188 IN LINE 74 OF Mcu\8051U\Src\eeprom.c: 'parameter 3': value truncated
   75   2          free(data_check);
   76   2          return true;
   77   2        }
   78   1        else{
   79   2          free(data_check);
   80   2          return false;
   81   2        }
   82   1      }
   83          
   84          void read_flash_bin(uint8_t* dat, uint32_t add, int out_buff_len)
   85          {
   86   1        int i;
   87   1        IAP_ENABLE();                           //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤Ÿ
   88   1          IAP_READ();                             //é€å­—èŠ‚è¯»å‘½ä»¤ï¼Œå‘½ä»¤ä¸éœ€æ”¹å˜æ—¶ï¼Œä¸éœ€é‡æ–°é€
             -å‘½ä»¤
   89   1        for (i = 0; i < out_buff_len ; i ++){
   90   2          CMD_FAIL = 0;
   91   2              IAP_ADDRE = (uint8_t)((add+i) >> 16); //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   92   2              IAP_ADDRH = (uint8_t)((add+i) >> 8);  //é€åœ°å€ä¸­å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   93   2              IAP_ADDRL = (uint8_t)(add+i);         //é€åœ°å€ä½å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   94   2      
   95   2          IAP_TRIG = 0x5A;
   96   2          IAP_TRIG = 0xA5;                   
   97   2          _nop_();   
   98   2          _nop_();
   99   2          _nop_();
  100   2          _nop_();
  101   2          while(CMD_FAIL);
  102   2      
  103   2              dat[i] = IAP_DATA;            //è¯»å‡ºçš„æ•°æ®é€å¾€
  104   2        }
  105   1      
  106   1        IAP_DISABLE();                      
  107   1      }
  108          
  109          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       381     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
C251 COMPILER V5.60.0,  eeprom                                                             24/10/24  23:51:05  PAGE 3   

  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  4 WARNING(S),  0 ERROR(S)

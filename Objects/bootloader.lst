C251 COMPILER V5.60.0,  bootloader                                                         21/10/24  11:26:47  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE bootloader
OBJECT MODULE PLACED IN .\Objects\bootloader.obj
COMPILER INVOKED BY: D:\Compiler\Keil_v5\C251\BIN\C251.EXE Bootloader\src\bootloader.c XSMALL FUNCTIONS(REENTRANT) FLOAT
                    -64 WARNINGLEVEL(3) OPTIMIZE(3,SPEED) BROWSE INCDIR(.\Bootloader\inc) DEBUG PRINT(.\Objects\bootloader.lst) TABS(2) OBJEC
                    -T(.\Objects\bootloader.obj) 

stmt  level    source

    1          /*
    2           * bootloader.c
    3           *
    4           *  Created on: Mar. 25, 2020
    5           *      Author: Alka
    6           *  Porting on: Mar. 13, 2024
    7           *    Porting code from F051 to STC8051U
    8           *  
    9           *
   10           */
   11          
   12          #include "bootloader.h"
   13          #include <string.h>
   14          
   15          
   16          #define page_size 0x200                   // 512 bytes for STC8051U
   17          
   18          extern void delayMicroseconds(uint32_t micros);
   19          
   20          void save_flash_nolib(uint8_t *dat, int length, uint32_t add){
   21   1      
   22   1        IAP_ENABLE();                         
   23   1        // unlock flash
   24   1        // erase page if address even divisable by 512
   25   1        if((add % page_size) == 0){
   26   2          CMD_FAIL = 0;
   27   2      
   28   2          IAP_ERASE();                        
   29   2      
   30   2          IAP_ADDRE = (uint8_t)(add >> 16); 
   31   2          IAP_ADDRH = (uint8_t)(add >> 8);  
   32   2          IAP_ADDRL = (uint8_t)add;         
   33   2      
   34   2          IAP_TRIG = 0x5A;
   35   2          IAP_TRIG = 0xA5;                   
   36   2          _nop_();   
   37   2          _nop_();
   38   2          _nop_();
   39   2          _nop_();
   40   2      
   41   2          while(CMD_FAIL);       
   42   2        }
   43   1      
   44   1        IAP_WRITE();        //å®è°ƒç”¨, é€å­—èŠ‚å†™å‘½ä»¤
   45   1        do
   46   1          {
   47   2          CMD_FAIL = 0;
   48   2      
   49   2              IAP_ADDRE = (uint8_t)(add >> 16); 
   50   2              IAP_ADDRH = (uint8_t)(add >> 8);  
   51   2              IAP_ADDRL = (uint8_t)add;         
   52   2              IAP_DATA  = *dat;      
   53   2      
   54   2          IAP_TRIG = 0x5A;
   55   2          IAP_TRIG = 0xA5;                   
   56   2          _nop_();   
   57   2          _nop_();
C251 COMPILER V5.60.0,  bootloader                                                         21/10/24  11:26:47  PAGE 2   

   58   2          _nop_();
   59   2          _nop_();
   60   2      
   61   2          while(CMD_FAIL);
   62   2      
   63   2              add++;                     //ä¸‹ä¸€ä¸ªåœ°å€
   64   2              dat++;                    //ä¸‹ä¸€ä¸ªæ•°æ®
   65   2          }
   66   1          while(--length);                    //ç›´åˆ°ç»“æŸ
   67   1      
   68   1      
   69   1        IAP_DISABLE();                      //å…³é—­IAP
   70   1      }
   71          
   72          void read_flash_bin(uint8_t*  dat , uint32_t add , int out_buff_len){
   73   1        int i;
   74   1        IAP_ENABLE();                           //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤Ÿ
   75   1          IAP_READ();                             //é€å­—èŠ‚è¯»å‘½ä»¤ï¼Œå‘½ä»¤ä¸éœ€æ”¹å˜æ—¶ï¼Œä¸éœ€é‡æ–°é€
             -å‘½ä»¤
   76   1        for (i = 0; i < out_buff_len ; i ++){
   77   2          CMD_FAIL = 0;
   78   2              IAP_ADDRE = (uint8_t)((add+i) >> 16); //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   79   2              IAP_ADDRH = (uint8_t)((add+i) >> 8);  //é€åœ°å€ä¸­å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   80   2              IAP_ADDRL = (uint8_t)(add+i);         //é€åœ°å€ä½å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
             -åœ°å€ï¼‰
   81   2      
   82   2          IAP_TRIG = 0x5A;
   83   2          IAP_TRIG = 0xA5;                   
   84   2          _nop_();   
   85   2          _nop_();
   86   2          _nop_();
   87   2          _nop_();
   88   2          while(CMD_FAIL);
   89   2      
   90   2              dat[i] = IAP_DATA;            //è¯»å‡ºçš„æ•°æ®é€å¾€
   91   2        }
   92   1      
   93   1        IAP_DISABLE();                      
   94   1      }
   95          
   96          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       278     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
